name: Build & Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-14]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Determine where the CMake project root is.
      # Some repo layouts have CMakeLists.txt at the repository root,
      # others keep the project under ./easy-stun.
      - name: Detect project root
        shell: bash
        run: |
          set -euo pipefail
          if [ -f CMakeLists.txt ]; then
            echo "PROJECT_DIR=." >> "$GITHUB_ENV"
          elif [ -f easy-stun/CMakeLists.txt ]; then
            echo "PROJECT_DIR=easy-stun" >> "$GITHUB_ENV"
          else
            echo "Could not find CMakeLists.txt in '.' or './easy-stun'" >&2
            ls -la
            exit 1
          fi
          echo "Detected PROJECT_DIR=${PROJECT_DIR:-<unset>}"

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build pkg-config libssl-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja openssl@3 pkg-config

      - name: Configure (Ubuntu)
        if: runner.os == 'Linux'
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Configure (macOS)
        if: runner.os == 'macOS'
        working-directory: ${{ env.PROJECT_DIR }}
        env:
          OPENSSL_ROOT_DIR: /opt/homebrew/opt/openssl@3
          PKG_CONFIG_PATH: /opt/homebrew/opt/openssl@3/lib/pkgconfig
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          cmake --build build

      - name: Package artifact
        working-directory: ${{ env.PROJECT_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          BIN="build/easy-stun"
          test -f "$BIN"

          OS="${{ runner.os }}"
          ARCH="${{ runner.arch }}"
          OUTDIR="dist"
          mkdir -p "$OUTDIR"

          NAME="easy-stun-${OS}-${ARCH}"
          cp "$BIN" "$OUTDIR/easy-stun"
          (cd "$OUTDIR" && tar -czf "${NAME}.tar.gz" easy-stun)

          echo "ASSET_PATH=${{ env.PROJECT_DIR }}/$OUTDIR/${NAME}.tar.gz" >> "$GITHUB_ENV"
          echo "ASSET_NAME=${NAME}.tar.gz" >> "$GITHUB_ENV"

      - name: Upload build artifact (non-tag)
        if: startsWith(github.ref, 'refs/tags/') != true
        uses: actions/upload-artifact@v4
        with:
          name: easy-stun-${{ runner.os }}-${{ runner.arch }}
          path: ${{ env.ASSET_PATH }}
          if-no-files-found: error

      - name: Upload release asset (tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
